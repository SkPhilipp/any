#!/usr/bin/env bash

set -e
set -o pipefail

auto_any_dir=$(dirname "${BASH_SOURCE[0]}")
auto_any_dockerfile=$(cd "$auto_any_dir" && cd .. && pwd)/Dockerfile.poetry

(
  # navigate to the root of the project
  while [ ! -f pyproject.toml ]; do
    cd ..
    if [ $PWD == "/" ]; then
      echo "Could not find pyproject.toml in any parent directory" >&2
      exit 1
    fi
  done

  # determine image name and tag
  image_name=$(basename "$PWD")
  image_tag="$image_name:$(date "+%Y%m%d%H%M%S")"

  # build the project and the docker image
  rm -rf dist/*
  poetry build
  poetry export --without-hashes --without dev > dist/requirements.txt
  docker build --build-arg IMAGE_NAME="$image_name" -f "$auto_any_dockerfile" . -t "$image_tag"

  # write the image tag to dist
  echo "$image_tag" > dist/image_tag
)
