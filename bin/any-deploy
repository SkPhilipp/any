#!/usr/bin/env bash

set -e
set -o pipefail

ANY_HOME=$(any home)

repository=$(git remote get-url origin)
branch=$(git rev-parse --abbrev-ref HEAD)
commit=$(git rev-parse HEAD)
sha256=$(echo -n "$repository:$branch" | shasum -a 256 | head -c 32)

cat "$ANY_HOME"/resources/templates/installation.yml \
  | value="$sha256" yq '.metadata.name = env(value)' - \
  | value="$repository" yq '.spec.repository = env(value)' - \
  | value="$branch" yq '.spec.branch = env(value)' - \
  | value="$commit" yq '.spec.commit = env(value)' - \
  | kubectl apply -f -

# TODO: wait for .namespace to be assigned to the installation
# TODO: wait for .url to be assigned to the installation
